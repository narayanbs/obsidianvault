
Digest Authentication provides a more secure method than Basic Authentication by hashing the password and using other information in the authentication process, which prevents sending the password in plain text.

#### Key Components of Digest Authentication:
- **`Authorization`**: The header sent by the client with the request containing the hashed credentials.
- **`WWW-Authenticate`**: The header sent by the server to challenge the client for authentication.

### Digest Authentication Workflow:

#### 1. **Client Request (Initial Request)**

The client sends an HTTP request to a protected resource on the server, without any authentication credentials (just like in Basic Authentication).

For example:

```
GET /protected/resource HTTP/1.1
Host: example.com
```

#### 2. **Server Response (Challenge)**

The server responds with a `401 Unauthorized` status code and sends a `WWW-Authenticate` header to challenge the client to authenticate using Digest Authentication.

The `WWW-Authenticate` header includes information such as the `realm`, a `nonce`, and other details.

Example of a server response:

```
HTTP/1.1 401 Unauthorized
WWW-Authenticate: Digest realm="Protected Area", qop="auth", nonce="dcd98b7102dd2f0e8b8c01df2e1b01a6e03d8f5f", opaque="5ccc069c403ebaf9f0171e9517f40e41", algorithm="MD5"
```

- **realm**: A string identifying the protected area.
- **nonce**: A unique value generated by the server to prevent replay attacks.
- **qop**: Quality of Protection, specifying what type of authentication is required (e.g., `auth` for basic authentication).
- **opaque**: An opaque string that must be included in the `Authorization` header sent by the client.
- **algorithm**: The algorithm used for the hashing process (usually `MD5`).

#### 3. **Client Sends Authentication (Authorization Header)**

After receiving the `401 Unauthorized` response, the client constructs the `Authorization` header. The client uses the credentials (`username` and `password`), and other pieces of information, to create a hash (`response`) that is sent in the `Authorization` header.

The `Authorization` header format looks like this:

```
Authorization: Digest username="admin", realm="Protected Area", nonce="dcd98b7102dd2f0e8b8c01df2e1b01a6e03d8f5f", uri="/protected/resource", response="e1671797c52e15f763380b45e841ec32", qop="auth", nc=00000001, cnonce="0a4f113b", opaque="5ccc069c403ebaf9f0171e9517f40e41", algorithm="MD5"
```

- **username**: The username of the user requesting authentication.
- **realm**: The realm from the `WWW-Authenticate` header.
- **nonce**: The nonce from the server’s response.
- **uri**: The URI of the resource being accessed.
- **response**: A hashed value calculated by the client. This is the most important part of the authentication, generated as:
  - `HA1 = MD5(username:realm:password)`
  - `HA2 = MD5(method:uri)`
  - `response = MD5(HA1:nonce:nonce-count:client-nonce:qop:HA2)`
- **qop**: Quality of Protection (e.g., `auth`).
- **nc**: Nonce Count (used for multiple requests in the same session).
- **cnonce**: Client Nonce (a value generated by the client to prevent replay attacks).
- **opaque**: The opaque string sent by the server.
- **algorithm**: The algorithm used to generate the hash (e.g., `MD5`).

#### 4. **Server Verifies the Credentials**

The server receives the `Authorization` header from the client. It then decodes and validates the hashed credentials:

- The server retrieves the stored password for the given username.
- The server hashes the password and other details (`nonce`, `uri`, etc.) in the same way as the client did.
- If the resulting hash matches the `response` in the client's `Authorization` header, the authentication is successful.

If the hashes match, the server grants access to the protected resource.

For example, the server might respond with the requested resource:

```
HTTP/1.1 200 OK
Content-Type: text/html
Content-Length: 123

<html>
  <body>
    <h1>Welcome, Admin!</h1>
    <p>This is the protected resource.</p>
  </body>
</html>
```

#### 5. **Access Denied (if credentials are invalid)**

If the credentials are incorrect, the server returns a `401 Unauthorized` status again and challenges the client to re-authenticate.

#### 6. **Subsequent Requests**

For subsequent requests to the same resource (or other protected resources on the server), the client may reuse the same authentication credentials (hashed value). If necessary, the `nonce` and `nc` values may change, depending on the server’s challenge.

---

### Digest Authentication Workflow Summary:

1. **Client Request**: The client sends a request to a protected resource.
2. **Server Challenge**: The server responds with a `401 Unauthorized` status and a `WWW-Authenticate` header that includes the `realm`, `nonce`, `qop`, and other details.
3. **Client Sends Authorization Header**: The client computes a hashed `response` based on the `username`, `password`, `nonce`, `uri`, and other details, and sends it in the `Authorization` header.
4. **Server Verifies the Response**: The server hashes the provided information and compares it with the `response` in the `Authorization` header. If they match, access is granted.
5. **Access Granted or Denied**: If the credentials are valid, the server responds with the requested resource. Otherwise, the server challenges the client again.

---

### Digest Authentication Example Flow:

6. **Initial Request**:

   ```bash
   curl http://example.com/protected/resource
   ```

   The server responds with a `401 Unauthorized` and a challenge:

   ```
   HTTP/1.1 401 Unauthorized
   WWW-Authenticate: Digest realm="Protected Area", qop="auth", nonce="dcd98b7102dd2f0e8b8c01df2e1b01a6e03d8f5f", opaque="5ccc069c403ebaf9f0171e9517f40e41", algorithm="MD5"
   ```

7. **Client Sends Authentication**:

   The client then constructs the `Authorization` header with the appropriate hashed credentials:

   ```bash
   curl -u admin:password123 --header "Authorization: Digest username=\"admin\", realm=\"Protected Area\", nonce=\"dcd98b7102dd2f0e8b8c01df2e1b01a6e03d8f5f\", uri=\"/protected/resource\", response=\"e1671797c52e15f763380b45e841ec32\", qop=\"auth\", nc=00000001, cnonce=\"0a4f113b\", opaque=\"5ccc069c403ebaf9f0171e9517f40e41\", algorithm=\"MD5\"" http://example.com/protected/resource
   ```

8. **Server Verifies and Grants Access**:

   If the credentials are correct, the server responds with the requested resource:

   ```
   HTTP/1.1 200 OK
   Content-Type: text/html
   Content-Length: 123

   <html>
     <body>
       <h1>Welcome, Admin!</h1>
       <p>This is the protected resource.</p>
     </body>
   </html>
   ```

### Key Takeaways:

- Digest Authentication is more secure than Basic Authentication because the password is never sent in plain text; it’s hashed.
- The authentication process uses a series of headers (`WWW-Authenticate` and `Authorization`).
- The `nonce`, `qop`, and other values prevent replay attacks and ensure the integrity of the authentication process.
- Digest Authentication requires hashing functions and nonce management to verify the identity of the user.